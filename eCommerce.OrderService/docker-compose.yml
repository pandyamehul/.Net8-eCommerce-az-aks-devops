services:
  ecomm.net9.aks.pg.userdb:
    image: postgres
    container_name: ecomm.net9.aks.pg.userdb
    hostname: ecomm.net9.aks.pg.userdb
    restart: always
    ports:
      - "5433:5432"
    volumes:
      - ecomm.net9.aks.pg.userdb.storage:/var/lib/postgresql/data
      - ../eCommerce.UserService/UserService.Db.Script:/docker-entrypoint-initdb.d
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=eCommerceUsers
    networks:
      - ecomm.net9.aks.pg.userdb.network

  ecomm.net9.aks.mysql.productdb:
    image: mysql:latest
    container_name: ecomm.net9.aks.mysql.productdb
    hostname: ecomm.net9.aks.mysql.productdb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: mysql-secret-pw
      MYSQL_DATABASE: eCommerceProducts
      MYSQL_USER: mysqluser
      MYSQL_PASSWORD: mysqlpassword
    ports:
      - 3306:3306
    volumes:
      - ecomm.net9.aks.mysql.productdb.storage:/var/lib/mysql
      - ../eCommerce.ProductService/ProductService.Db.Script:/docker-entrypoint-initdb.d
    networks:
      - ecomm.net9.aks.mysql.productdb.network

  ecomm.net9.aks.mongo.orderdb:
    image: mongo:latest
    container_name: ecomm.net9.aks.mongo.orderdb
    hostname: ecomm.net9.aks.mongo.orderdb
    restart: unless-stopped
    ports:
      - 27018:27017
    volumes:
      - ecomm.net9.aks.mongo.orderdb.storage:/var/lib/mongodb
      - ../eCommerce.OrderService/OrderService.Db.Script:/docker-entrypoint-initdb.d
    networks:
      - ecomm.net9.aks.mongo.orderdb.network

  ecomm.net9.aks.redis.cache:
    image: redis:latest
    container_name: ecomm.net9.aks.redis.cache
    hostname: ecomm.net9.aks.redis.cache
    restart: unless-stopped
    ports:
      - 6380:6379
    volumes:
      - ecomm.net9.aks.redis.cache.storage:/data
    networks:
      - ecomm.net9.aks.network

  ecomm.net9.aks.msg.queues:
    image: rabbitmq:management
    container_name: ecomm.net9.aks.msg.queues
    hostname: ecomm.net9.aks.msg.queues
    restart: always
    ports:
      - "5673:5672"
      - "15673:15672"
    volumes:
      - ecomm.net9.aks.msg.queues.storage:/var/lib/rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    networks:
      - ecomm.net9.aks.network

  net9-ecomm-userapi:
    image: net9-ecomm-userapi:2.0
    environment:
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTP_ENVIRONMENT=Development
      - POSTGRESDB_HOST=ecomm.net9.aks.pg.userdb
      - POSTGRESDB_PORT=5432
      - POSTGRESDB_NAME=eCommerceUsers
      - POSTGRESDB_USER=postgres
      - POSTGRESDB_PASSWORD=postgres
    ports:
      - "5000:9090"
    networks:
      - ecomm.net9.aks.network
      - ecomm.net9.aks.pg.userdb.network
    depends_on:
      - ecomm.net9.aks.pg.userdb

  net9-ecomm-productapi:
    image: net9-ecomm-productapi:2.1
    environment:
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_ENVIRONMENT=Development
      - MYSQL_HOST=ecomm.net9.aks.mysql.productdb
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=eCommerceProducts
      - MYSQL_USER=mysqluser
      - MYSQL_PASSWORD=mysqlpassword
      - RabbitMQ_HostName=ecomm.net9.aks.msg.queues
      - RabbitMQ_UserName=guest
      - RabbitMQ_Password=guest
      - RabbitMQ_Port=5672
      - RabbitMQ_Products_Exchange=product.exchange
    ports:
      - "6000:8080"
    networks:
      - ecomm.net9.aks.network
      - ecomm.net9.aks.mysql.productdb.network
    depends_on:
      - ecomm.net9.aks.mysql.productdb

  net9-ecomm-orderapi:
    image: net9-ecomm-orderapi
    hostname: net9-ecomm-orderapi
    build:
      context: .
      dockerfile: OrderService.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - MONGODB_HOST=ecomm.net9.aks.mongo.orderdb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=OrdersDatabase
      - REDIS_HOST=ecomm.net9.aks.redis.cache
      - REDIS_PORT=6379
      - RabbitMQ_HostName=ecomm.net9.aks.msg.queues
      - RabbitMQ_UserName=guest
      - RabbitMQ_Password=guest
      - RabbitMQ_Port=5672
      - RabbitMQ_Products_Exchange=product.exchange
      - OCELOT_CONFIGFILE=ocelot.json
      # Local docker endpoint settings for dependent services (used in debugging mode)
      # - UserServiceName=net9-ecomm-userapi
      # - UserServicePort=9090
      # - ProductServiceName=net9-ecomm-productapi
      # - ProductServicePort=8080

      # Local docker endpoint settings for dependent services via API Gateway (used in debugging mode)
      - UserServiceName=net9-ecomm-apigateway
      - UserServicePort=8080
      - ProductServiceName=net9-ecomm-apigateway
      - ProductServicePort=8080
    ports:
      - "7000:8080"
    networks:
      - ecomm.net9.aks.network
      - ecomm.net9.aks.mongo.orderdb.network
    depends_on:
      - ecomm.net9.aks.mongo.orderdb

  net9-ecomm-apigateway:
    image: net9-ecomm-apigateway
    hostname: net9-ecomm-apigateway
    build:
      context: .
      dockerfile: ./OrderService.ApiGw/Dockerfile
    ports:
      - "4000:8080"
    networks:
      - ecomm.net9.aks.network

volumes:
  ecomm.net9.aks.pg.userdb.storage:
  ecomm.net9.aks.mysql.productdb.storage:
  ecomm.net9.aks.mongo.orderdb.storage:
  ecomm.net9.aks.redis.cache.storage:
  ecomm.net9.aks.msg.queues.storage:

networks:
  ecomm.net9.aks.network:
    name: ecomm.net9.aks.network
    driver: bridge
  ecomm.net9.aks.pg.userdb.network:
    name: ecomm.net9.aks.pg.userdb.network
    driver: bridge
  ecomm.net9.aks.mysql.productdb.network:
    name: ecomm.net9.aks.mysql.productdb.network
    driver: bridge
  ecomm.net9.aks.mongo.orderdb.network:
    name: ecomm.net9.aks.mongo.orderdb.network
    driver: bridge
